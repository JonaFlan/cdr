{% extends "core/base.html" %}
{% load static %}

{% block title %}Sesiones{% endblock %}

{% block custom %}
<link rel="stylesheet" href="{% static 'css/sesiones.css' %}">
{% endblock %}

{% block content %}
<main class="container p-3 mt-5">
    <!-- Mostrar mensajes -->
    <div class="row">
        {% for message in messages %}
            <div class="col-12 mb-2">
                <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        {% endfor %}
    </div>
    
    <div class="row">
        
        {% if user.is_authenticated %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 d-flex align-items-center justify-content-center game-card position-relative" style="background-color: #0D1D13; border: 1px solid #1A3B2A; color: #C8D6C3;">
                <a href="{% url 'sesion_create' %}" class="btn btn-icon d-flex align-items-center justify-content-center" style="width: 100%; height: 100%; text-decoration: none;">
                    <i class="fas fa-plus" style="font-size: 3rem; color: #A1C181;" title="Agregar Sesion"></i>
                </a>
            </div>
        </div>
        {% endif %}

        {% for sesion in sesiones %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="sesion-card">
                    <!-- Header con íconos de inscripción, estado e iniciar asistencia -->
                    <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #1A3B2A; color: #C8D6C3;">
                        <div>
                            {% if user.is_authenticated %}
                                {% if user != sesion.creador %}
                                    {% if user in sesion.participantes.all %}
                                        <!-- El usuario ya confirmó su asistencia, no mostrar botones -->
                                    {% else %}
                                        {% if sesion.estado == 'en_curso' and user in sesion.usuarios_inscritos.all %}
                                            <!-- Botón para confirmar asistencia -->
                                            <button type="button" class="btn btn-icon" data-bs-toggle="modal" 
                                                    data-bs-target="#asistenciaModal" data-id="{{ sesion.id }}" 
                                                    title="Confirmar asistencia">
                                                <i class="fas fa-user-check" style="font-size: 1.5rem; color: #A1C181;"></i>
                                            </button>
                                        {% elif sesion.estado == 'pendiente' and user in sesion.usuarios_inscritos.all %}
                                            <!-- Icono para anular inscripción -->
                                            <a href="{% url 'anular_inscripcion_sesion' sesion.id %}" 
                                            class="btn btn-icon" title="Anular inscripción">
                                                <i class="fas fa-times-circle" style="font-size: 1.5rem; color: #A1C181;"></i>
                                            </a>
                                        {% elif sesion.estado == 'pendiente' and user not in sesion.usuarios_inscritos.all %}
                                            <!-- Icono para inscribirse -->
                                            <a href="{% url 'inscribirse_sesion' sesion.id %}" 
                                            class="btn btn-icon" title="Inscribirse">
                                                <i class="fas fa-user-plus" style="font-size: 1.5rem; color: #A1C181;"></i>
                                            </a>
                                        {% endif %}
                                    {% endif %}
                                {% elif user == sesion.creador %}
                                    {% if sesion.estado == 'pendiente' %}
                                        <!-- Icono para iniciar sesión -->
                                        <a href="{% url 'iniciar_sesion_juego' sesion.id %}" 
                                        class="btn btn-icon" title="Iniciar Sesión">
                                            <i class="fas fa-play-circle" style="font-size: 1.5rem; color: #A1C181;"></i>
                                        </a>
                                    {% elif sesion.estado == 'en_curso' %}
                                        <!-- Ícono para mostrar/ocultar el código -->
                                        <button class="btn btn-icon toggle-code-btn" title="Mostrar/Ocultar código"
                                                data-bs-toggle="tooltip" onclick="toggleCodigo({{ sesion.id }})">
                                            <i class="fas fa-key" style="font-size: 1.5rem; color: #A1C181;"></i>
                                        </button>
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        </div>
                    
                        <!-- Código de la sesión oculto al inicio -->
                        {% if sesion.estado == 'en_curso' %}
                            <div id="codigo-sesion-{{ sesion.id }}" class="text-end ms-auto me-2" style="display: none;">
                                <p style="margin: 0; font-size: 0.9rem; color: #C8D6C3;"><strong>{{ sesion.codigo_secreto }}</strong></p>
                            </div>
                        {% endif %}
                    </div>


    
                    <!-- Imagen del juego -->
                    {% if sesion.juego.imagen %}
                        <img src="{{ sesion.juego.imagen.url }}" alt="{{ sesion.juego.nombre }}" 
                             class="img-fluid w-100">
                    {% else %}
                        <img src="https://via.placeholder.com/200" alt="Imagen no disponible" 
                             class="img-fluid w-100">
                    {% endif %}
    
                    <!-- Detalles de la sesión -->
                    <div class="sesion-card-body">
                        <p class="sesion-card-text"><strong>Juego:</strong> {{ sesion.juego.nombre }}</p>
                        <p class="sesion-card-text"><strong>Fecha:</strong> {{ sesion.fecha }}</p>
                        <p class="sesion-card-text"><strong>Lugar:</strong> {{ sesion.lugar }}</p>
                        <p class="sesion-card-text"><strong>Cupos disponibles:</strong> {{ sesion.cupos_disponibles }}</p>
                        {% if sesion.estado != "pendiente" %}
                        <p class="sesion-card-text"><strong>Estado:</strong> {{ sesion.get_estado_display }}</p>
                        {% endif %}
                        <!-- Inscritos -->
                        <div class="inscritos-img d-flex justify-content-center flex-wrap">
                            {% for usuario in sesion.usuarios_inscritos.all %}
                                <div class="position-relative mx-1">
                                    <!-- Enlace a perfil con tooltip -->
                                    <a href="{% url 'ver_perfil_usuario' usuario.username %}" data-bs-toggle="tooltip" 
                                    title="{{ usuario.username }}" 
                                    class="{% if usuario in sesion.participantes.all %}confirmed-participant{% endif %}">
                                        <img src="{% static usuario.perfil.imagen %}" 
                                            alt="{{ usuario.username }}" 
                                            class="rounded-circle border" height="50" width="50">
                                    </a>
                                    {% if usuario in sesion.usuarios_participantes.all %}
                                        <!-- Ticket sobrepuesto -->
                                        <div class="participation-badge position-absolute">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
    
                    <!-- Footer con botones de administración -->
                    {% if user.is_authenticated and sesion.creador == user %}
                        {% if sesion.estado != 'finalizada' %}
                            <div class="card-footer d-flex justify-content-between" 
                                style="background-color: #1A3B2A; color: #C8D6C3;">
                                {% if sesion.estado == 'en_curso' %}
                                    <!-- Botón para finalizar sesión -->
                                    <button type="button" class="btn btn-icon" data-bs-toggle="modal" 
                                            data-bs-target="#finalizarModal{{ sesion.id }}" title="Finalizar sesión">
                                        <i class="fas fa-check-circle" style="font-size: 1.5rem; color: #A1C181;"></i>
                                    </button>
                                {% else %}
                                    <!-- Botón para editar sesión -->
                                    <a href="{% url 'sesion_update' sesion.id %}" class="btn btn-icon" title="Editar">
                                        <i class="fas fa-edit" style="font-size: 1.5rem; color: #A1C181;"></i>
                                    </a>
                                {% endif %}
                                <!-- Botón para eliminar sesión -->
                                <button type="button" class="btn btn-icon" data-bs-toggle="modal" 
                                        data-bs-target="#deleteModal" title="Eliminar"
                                        data-id="{{ sesion.id }}" data-titulo="{{ sesion.titulo }}">
                                    <i class="fas fa-trash" style="font-size: 1.5rem; color: #A1C181;"></i>
                                </button>
                            </div>
                        {% endif %}
                    {% endif %}

                    <!-- Modal para finalizar sesiones -->
                    <div class="modal fade" id="finalizarModal{{ sesion.id }}" tabindex="-1" aria-labelledby="finalizarModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content" style="background-color: #1A3B2A; color: #C8D6C3;">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="finalizarModalLabel">Finalizar Sesión</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p>Al finalizar esta sesión, las siguientes recompensas serán otorgadas:</p>
                                    <ul>
                                        <li><strong>Creador:</strong> 50 XP, 100 CDLC</li>
                                        <li><strong>Participantes:</strong> 20 XP, 10 CDLC cada uno</li>
                                    </ul>
                                    <p>¿Estás seguro de que deseas finalizar esta sesión?</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <a href="{% url 'finalizar_sesion' sesion.id %}" class="btn btn-success">Finalizar Sesión</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        {% endfor %}
    </div>


    </div>

</main>

<!-- Modal de confirmación para eliminar la sesión -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: #1A3B2A; color: #C8D6C3;">
            <div class="modal-header" style="border-bottom: 1px solid #A1C181;">
                <h5 class="modal-title" id="deleteModalLabel" style="color: #A1C181;">Confirmar eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ¿Estás seguro de que deseas eliminar la sesión "<span id="sesionTitulo"></span>"?. Esta acción no se puede deshacer.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background-color: #6C757D; border: none;">Cancelar</button>
                
                <!-- Formulario POST para eliminar la sesión -->
                <form method="POST" id="deleteForm">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" style="background-color: #A1C181; border: none;">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para confirmar asistencia -->
<div class="modal fade" id="asistenciaModal" tabindex="-1" aria-labelledby="asistenciaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: #1A3B2A; color: #C8D6C3;">
            <div class="modal-header" style="border-bottom: 1px solid #A1C181;">
                <h5 class="modal-title" id="asistenciaModalLabel" style="color: #A1C181;">Confirmar asistencia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Introduce el código de la sesión para confirmar tu asistencia:</p>
                <form method="POST" id="asistenciaForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <input type="text" class="form-control" name="codigo_sesion" placeholder="Código de sesión" required>
                    </div>
                    <button type="submit" class="btn btn-success" style="background-color: #A1C181; border: none;">Confirmar</button>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
    const deleteModal = document.getElementById('deleteModal');
    deleteModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget; // Botón que activó el modal
        const sesionId = button.getAttribute('data-id');
        const sesionTitulo = button.getAttribute('data-titulo');
        
        // Actualizar el título de la sesión en el modal
        const tituloElement = document.getElementById('sesionTitulo');
        tituloElement.textContent = sesionTitulo;
    
        // Crear el formulario dinámicamente con el ID de la sesión
        const deleteForm = document.getElementById('deleteForm');
        deleteForm.action = "/sesiones/eliminar/0/".replace('0', sesionId);
    });

    const asistenciaModal = document.getElementById('asistenciaModal');
    asistenciaModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget; // Botón que activó el modal
        const sesionId = button.getAttribute('data-id');
        
        // Crear el formulario dinámicamente con el ID de la sesión
        const asistenciaForm = document.getElementById('asistenciaForm');
        asistenciaForm.action = "/sesiones/asistencia/0/".replace('0', sesionId);
    });

    document.addEventListener('DOMContentLoaded', function () {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });

    function toggleCodigo(sesionId) {
        const codigoSesion = document.getElementById(`codigo-sesion-${sesionId}`);
        if (codigoSesion.style.display === "none") {
            codigoSesion.style.display = "block";
        } else {
            codigoSesion.style.display = "none";
        }
    }
</script>
    
{% endblock %}